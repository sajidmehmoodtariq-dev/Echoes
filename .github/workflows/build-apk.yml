name: Manual Expo APK Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=8192

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. We need Node.js to run Expo commands
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20" # Upgraded to Node 20 to support Array.toReversed() used by Metro Bundler

      # 2. Install your project packages
      - name: Install dependencies
        run: npm install

      # 3. Set up Java for the Android build
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      # 4. The Magic Step: This generates the 'android' folder and gradlew!
      - name: Generate Native Android folder
        run: npx expo prebuild --platform android

      # 5. Now we can make the generated gradlew executable
      - name: Make gradlew executable
        run: chmod +x ./android/gradlew

      # 6. Build the APK from inside the generated android directory
      - name: Build Release APKs
        run: cd android && ./gradlew assembleRelease

      # 7. Upload the final APKs (note the updated path)
      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apks
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 7
